- hosts: all
  collections:
    - fortinet.fortimanager
  connection: httpapi
  vars:
     ansible_httpapi_use_ssl: True
     ansible_httpapi_validate_certs: False
     ansible_httpapi_port: 443
     FORTICLOUD_APIID: 7F217031-9D17-48DB-9D2F-5B45E4761F01
     FORTICLOUD_PASSWD: 402bef868a9f3270445974d9c9624c4d!1Aa
   
  tasks:
   - name: Generate Access Token From FortiCloud Auth Server.
     uri:
       url: https://customerapiauth.fortinet.com/api/v1/oauth/token/
       method: POST
       body_format: json
       return_content: true
       headers:
         Content-Type: application/json
       body: '{"username": "{{ FORTICLOUD_APIID }}", "password": "{{ FORTICLOUD_PASSWD }}", "client_id": "FortiManager", "grant_type": "password"}'
     register: tokeninfo

#
## add adom, configure with script
#
    - name: create policy package {{polpkg}}
      fmgr_generic:
        forticloud_access_token: '{{ tokeninfo.json.access_token }}'
        method: set
        params:
          - url: '/pm/pkg/adom/{{adom}}'
            data:
              - name: '{{polpkg}}'
                type: pkg
                package_setting:
                  central-nat: disable

    - name: delete polpkg 'default'
      fmgr_generic:
        forticloud_access_token: '{{ tokeninfo.json.access_token }}'
        method: delete
        params:
          - url: '/pm/pkg/adom/{{adom}}/default'

    - name: create script {{script_adom}} to configure adom {{adom}}
      fmgr_generic:
        forticloud_access_token: '{{ tokeninfo.json.access_token }}'
        method: set
        params:
          - url: '/dvmdb/adom/{{adom}}/script'
            data:
              - name: '{{script_adom}}'
                target: adom_database
                type: cli
                content: |
                  ### FSW
                  config fsp vlan
                      edit "POS"
                          set vlanid 100
                      next
                      edit "SecureWLan"
                          set vlanid 110
                          config interface
                             set allowaccess fabric ping
                          end
                      next
                      edit "GuestWLan"
                          set vlanid 200
                      next
                      edit "Isolate_FEX"
                          set vlanid 4080
                          set _dhcp-status enable
                          config interface
                              set ip 169.254.2.1 255.255.255.0
                              set allowaccess ping fabric
                              set description "Isolate_FEX"
                              set device-identification enable
                              set role lan
                          end
                          config dhcp-server
                              set id 2
                              set default-gateway 169.254.2.1
                              set netmask 255.255.255.0
                              set dns-service default
                              set ntp-service default
                              config ip-range
                                  edit 1
                                      set start-ip 169.254.2.2
                                      set end-ip 169.254.2.6
                                  next
                              end
                          end
                      next
                      edit "BackOffice"
                          set vlanid 120
                      next
                      edit "IoT"
                          set vlanid 130
                      next
                  end
                  ### FSW
                  config switch-controller managed-switch
                    edit "{{fsw}}"
                      set name "{{fsw_tpt}}"
                      set description "FortiSwitch Template for North America 108E-POE"
                      set _platform "FortiSwitch-108E"
                      config ports
                        edit "port1"
                          set vlan "SecureWLan"
                          #set poe-capable 1
                          set allowed-vlans "GuestWLan" "quarantine"
                          set untagged-vlans "quarantine"
                          #set export-to "root"
                        next
                        edit "port2"
                          set vlan "POS"
                          #set poe-capable 1
                          set allowed-vlans "quarantine"
                          set untagged-vlans "quarantine"
                          set stp-root-guard enabled
                          set stp-bpdu-guard enabled
                          set loop-guard enabled
                        next
                        edit "port3"
                          set vlan "default"
                          #set poe-capable 1
                          set allowed-vlans "quarantine"
                          set untagged-vlans "quarantine"
                        next
                        edit "port4"
                          set vlan "Isolate_FEX"
                          #set poe-capable 1
                          set allowed-vlans "quarantine"
                          set untagged-vlans "quarantine"
                        next
                        edit "port5"
                          set vlan "POS"
                          set untagged-vlans "quarantine"
                          set stp-root-guard enabled
                          set stp-bpdu-guard enabled
                          set loop-guard enabled
                        next
                        edit "port6"
                          set vlan "default"
                          set allowed-vlans "quarantine"
                          set untagged-vlans "quarantine"
                        next
                        edit "port7"
                          set vlan "default"
                          set allowed-vlans "quarantine"
                          set untagged-vlans "quarantine"
                        next
                        edit "port8"
                          set vlan "default"
                          set allowed-vlans "quarantine"
                          set untagged-vlans "quarantine"
                        next
                        edit "port9"
                          set vlan "default"
                          set allowed-vlans "quarantine"
                          set untagged-vlans "quarantine"
                        next
                        edit "port10"
                          set vlan "default"
                          set allowed-vlans "quarantine"
                          set untagged-vlans "quarantine"
                        next
                      end
                    next
                  end
                  ### FAP
                  config wireless-controller vap
                      edit "SSID-P_Guest"
                          set ssid "Acme_Guest_POC"
                          set security open
                          set local-bridging enable
                          set intra-vap-privacy enable
                          set vlanid 200
                          set _intf_ip 0.0.0.0 0.0.0.0
                      next
                      edit "SSID-P_Secure"
                          set ssid "Acme_Secure_POC"
                          set passphrase "P_Secure" # 5..8 chars
                          set local-bridging enable
                          set schedule "always"
                          set _intf_ip 0.0.0.0 0.0.0.0
                      next
                  end
                  ### FAP
                  config wireless-controller wtp-profile
                      edit "{{fap_prof}}"
                         config platform
                            set type 24D
                          end
                          set ap-country US
                          set allowaccess https ssh snmp
                          set login-passwd-change yes
                          set login-passwd "wtp-prof" # 5..8 chars
                          set handoff-sta-thresh 30
                          config radio-1
                              set band 802.11n
                              set wids-profile "default-wids-apscan-enabled"
                              set darrp enable
                              #set frequency-handoff enable
                              set vap-all disable # =manual in 6.4
                              set vaps "SSID-P_Guest" "SSID-P_Secure"
                              set channel "1" "6" "11"
                          end
                          #config radio-2
                          #    set band 802.11ac
                          #    set channel-bonding 40MHz
                          #    set wids-profile "default-wids-apscan-enabled"
                          #    set vap-all disable
                          #    set vaps "SSID-P_Guest" "SSID-P_Secure"
                          #    set channel "36" "40" "44" "48" "149" "153" "157" "161"
                          #end
                      next
                  end

                  # pre-SDWAN
                  config dynamic virtual-wan-link neighbor
                    edit "BGPN1"
                      set ip "1.1.1.1"
                    next
                  end
                  config dynamic virtual-wan-link server
                  #aka adom for: config health-check
                      edit "Default_Office_365"
                          set server "www.office.com"
                          #set protocol http
                          #set interval 1000
                          #set probe-timeout 1000
                          #set recoverytime 10
                          #config sla
                          #    edit 1
                          #        set latency-threshold 250
                          #        set jitter-threshold 50
                          #        set packetloss-threshold 5
                          #    next
                          #end
                      next
                      edit "Default_Gmail"
                          set server "gmail.com"
                          #set interval 1000
                          #set probe-timeout 1000
                          #set recoverytime 10
                          #config sla
                          #    edit 1
                          #        set latency-threshold 250
                          #        set jitter-threshold 50
                          #        set packetloss-threshold 2
                          #    next
                          #end
                      next
                      edit "Default_AWS"
                          set server "aws.amazon.com"
                          #set protocol http
                          #set interval 1000
                          #set probe-timeout 1000
                          #set recoverytime 10
                          #config sla
                          #    edit 1
                          #        set latency-threshold 250
                          #        set jitter-threshold 50
                          #        set packetloss-threshold 5
                          #    next
                          #end
                      next
                      edit "Default_Google Search"
                          set server "www.google.com"
                          #set protocol http
                          #set interval 1000
                          #set probe-timeout 1000
                          #set recoverytime 10
                          #config sla
                          #    edit 1
                          #        set latency-threshold 250
                          #        set jitter-threshold 50
                          #        set packetloss-threshold 5
                          #    next
                          #end
                      next
                      edit "Default_FortiGuard"
                          set server "fortiguard.com"
                          #set protocol http
                          #set interval 1000
                          #set probe-timeout 1000
                          #set recoverytime 10
                          #config sla
                          #    edit 1
                          #        set latency-threshold 250
                          #        set jitter-threshold 50
                          #        set packetloss-threshold 5
                          #    next
                          #end
                      next
                      edit "Internet Health Check"
                          set server "8.8.8.8" "4.2.2.2"
                          #set interval 5000
                          #set update-cascade-interface disable
                          #set update-static-route disable
                          #set sla-fail-log-period 15
                          #set sla-pass-log-period 60
                          #set threshold-warning-packetloss 2
                          #set threshold-alert-packetloss 5
                          #set threshold-warning-latency 100
                          #set threshold-alert-latency 250
                          #set members 1 2
                          #config sla
                          #    edit 1
                          #        set latency-threshold 250
                          #        set packetloss-threshold 5
                          #    next
                          #end
                      next
                    #end
                    #edit "HCS1"
                    #  set server 1.1.1.1
                    #next
                  end

                  config user radius
                      edit "Purple RADIUS"
                          set server "rad1-us.venuewifi.net"
                          set secret "user radius secret"
                          set auth-type pap
                          set secondary-server "rad2-us.venuewifi.net"
                          set secondary-secret "user radius secondary-secret"
                      next
                  end
                  config user group
                      edit "Purple Guests"
                          set member "Purple RADIUS"
                      next
                  end

                  config firewall address
                      edit "Google Primary DNS"
                          set subnet 8.8.8.8 255.255.255.255
                      next
                      edit "Google Secondary DNS"
                          set subnet 8.8.4.4 255.255.255.255
                      next
                      edit "IS-NETENG-MBP"
                          set subnet 192.168.1.171 255.255.255.255
                      next
                      edit "abs-0.twimg.com"
                          set type fqdn
                          set fqdn "abs-0.twimg.com"
                      next
                      edit "abs.twimg.com"
                          set type fqdn
                          set fqdn "abs.twimg.com"
                      next
                      edit "api.openweathermap.org"
                          set type fqdn
                          set fqdn "api.openweathermap.org"
                      next
                      edit "api.stripe.com"
                          set type fqdn
                          set fqdn "api.stripe.com"
                      next
                      edit "api.twitter.com"
                          set type fqdn
                          set fqdn "api.twitter.com"
                      next
                      edit "connect.facebook.net"
                          set type fqdn
                          set fqdn "connect.facebook.net"
                      next
                      edit "d1ldbb6wxu8wdm.cloudfront.net"
                          set type fqdn
                          set fqdn "d1ldbb6wxu8wdm.cloudfront.net"
                      next
                      edit "dow"
                          set type fqdn
                          set fqdn "dowj6t3sraq9r.cloudfront.net"
                      next
                      edit "facebook.com"
                          set type fqdn
                          set fqdn "facebook.com"
                      next
                      edit "fbstatic-a.akamaihd.net"
                          set type fqdn
                          set fqdn "fbstatic-a.akamaihd.net"
                      next
                      edit "instagram.com"
                          set type fqdn
                          set fqdn "instagram.com"
                      next
                      edit "instagramstatic-a.akamaihd.net"
                          set type fqdn
                          set fqdn "instagramstatic-a.akamaihd.net"
                      next
                      edit "linkedin.com"
                          set type fqdn
                          set fqdn "linkedin.com"
                      next
                      edit "login.sina.com.cn"
                          set type fqdn
                          set fqdn "login.sina.com.cn"
                      next
                      edit "m.facebook.com"
                          set type fqdn
                          set fqdn "m.facebook.com"
                      next
                      edit "payment-r1.venuewifi.com"
                          set type fqdn
                          set fqdn "payment-r1.venuewifi.com"
                      next
                      edit "payment-r2.venuewifi.com"
                          set type fqdn
                          set fqdn "payment-r2.venuewifi.com"
                      next
                      edit "payment-r3.venuewifi.com"
                          set type fqdn
                          set fqdn "payment-r3.venuewifi.com"
                      next
                      edit "r1-portal.venuewifi.com"
                          set type fqdn
                          set fqdn "r1-portal.venuewifi.com"
                      next
                      edit "r2-portal.venuewifi.com"
                          set type fqdn
                          set fqdn "r2-portal.venuewifi.com"
                      next
                      edit "r3-portal.venuewifi.com"
                          set type fqdn
                          set fqdn "r3-portal.venuewifi.com"
                      next
                      edit "region1.purpleportal.net"
                          set type fqdn
                          set fqdn "region1.purpleportal.net"
                      next
                      edit "scontent-lhr3-1.xx.fbcdn.net"
                          set type fqdn
                          set fqdn "scontent-lhr3-1.xx.fbcdn.net"
                      next
                      edit "static.licdn.com"
                          set type fqdn
                          set fqdn "static.licdn.com"
                      next
                      edit "touch.linkedin.com"
                          set type fqdn
                          set fqdn "touch.linkedin.com"
                      next
                      edit "twitter.com"
                          set type fqdn
                          set fqdn "twitter.com"
                      next
                      edit "vk.com"
                          set type fqdn
                          set fqdn "vk.com"
                      next
                      edit "vk.me"
                          set type fqdn
                          set fqdn "vk.me"
                      next
                      edit "weibo.com"
                          set type fqdn
                          set fqdn "weibo.com"
                      next
                      edit "www.facebook.com"
                          set type fqdn
                          set fqdn "www.facebook.com"
                      next
                      edit "www.instagram.com"
                          set type fqdn
                          set fqdn "www.instagram.com"
                      next
                      edit "www.linkedin.com"
                          set type fqdn
                          set fqdn "www.linkedin.com"
                      next
                      edit "www.twitter.com"
                          set type fqdn
                          set fqdn "www.twitter.com"
                      next
                      edit "www.vk.com"
                          set type fqdn
                          set fqdn "www.vk.com"
                      next
                      edit "www.vk.me"
                          set type fqdn
                          set fqdn "www.vk.me"
                      next
                      edit "www.weibo.com"
                          set type fqdn
                          set fqdn "www.weibo.com"
                      next
                  end

                  config firewall service custom
                      edit "CUST-TCP-5088"
                          set tcp-portrange 5088
                      next
                      edit "CUST-TCP-5187"
                          set tcp-portrange 5187
                      next
                      edit "CUST-TCP-5190"
                          set tcp-portrange 5190
                      next
                      edit "CUST-TCP-10000"
                          set tcp-portrange 10000
                      next
                      edit "CUST-TCP-45088"
                          set tcp-portrange 45088
                      next
                      edit "CUST-TCP-45135"
                          set tcp-portrange 45135
                      next
                      edit "CUST-TCP-45555"
                          set tcp-portrange 45555
                      next
                      edit "CUST-TCP-444"
                          set tcp-portrange 444
                      next
                      edit "CUST-TCP-8000"
                          set tcp-portrange 8000
                      next
                      edit "CUST-UDP-5000"
                          set udp-portrange 5000
                      next
                      edit "CUST-UDP-6000"
                          set udp-portrange 6000
                      next
                      edit "CUST-UDP-9999"
                          set udp-portrange 9999
                      next
                      edit "CUST-TCP-3690"
                          set tcp-portrange 3690
                      next
                      edit "CUST-TCP-5001"
                          set tcp-portrange 5001
                      next
                      edit "CUST-TCP-5050"
                          set tcp-portrange 5050
                      next
                      edit "CUST-TCP-UDP-52311"
                          set udp-portrange 52311
                      next
                      edit "CUST-TCP-9997-9998"
                          set tcp-portrange 9997-9998
                      next
                      edit "CUST-TCP-3317-3319"
                          set tcp-portrange 3317-3319
                      next
                      edit "CUST-TCP-81-83"
                          set tcp-portrange 81-83
                      next
                      edit "CUST-TCP-2222"
                          set tcp-portrange 2222
                      next
                      edit "CUST-TCP-UDP-5938"
                          set tcp-portrange 5938
                          set udp-portrange 5938
                      next
                      edit "CUST-TCP-8080"
                          set tcp-portrange 8080
                      next
                      edit "CUST-TCP-8443"
                          set tcp-portrange 8443
                      next
                  end

                  config firewall service group
                      edit "SG_BARCLAY"
                          set member "CUST-TCP-5088" "CUST-TCP-5187" "CUST-TCP-5190" "CUST-TCP-10000" "CUST-TCP-45088" "CUST-TCP-45135" "CUST-TCP-45555"
                      next
                      edit "SG_Grace-Radio"
                          set member "CUST-TCP-444" "CUST-TCP-8000" "CUST-UDP-5000" "CUST-UDP-6000" "CUST-UDP-9999"
                      next
                  end

                  config firewall profile-group
                      edit "PG_POS"
                          set av-profile "default"
                          set webfilter-profile "default"
                          set ips-sensor "default"
                          set application-list "default"
                      next
                  end
                  config firewall policy
                      edit 1
                          set name "IPv4-P_BARCLAY"
                          set srcintf "POS"
                          set dstintf "virtual-wan-link"
                          set srcaddr "all"
                          set dstaddr "all"
                          set action accept
                          set schedule "always"
                          set service "SG_BARCLAY"
                          set utm-status enable
                          set profile-type group
                          set profile-group "PG_POS"
                          set logtraffic all
                          set global-label "POS"
                      next
                      edit 2
                          set name "IPv4-P_GRACE-RADIO"
                          set srcintf "POS"
                          set dstintf "virtual-wan-link"
                          set srcaddr "all"
                          set dstaddr "all"
                          set action accept
                          set schedule "always"
                          set service "SG_Grace-Radio"
                          set utm-status enable
                          set profile-type group
                          set profile-group "PG_POS"
                          set logtraffic all
                      next
                      edit 3
                          set name "IPv4-P_Acme-RADIO"
                          set srcintf "POS"
                          set dstintf "virtual-wan-link"
                          set srcaddr "all"
                          set dstaddr "all"
                          set action accept
                          set schedule "always"
                          set service "CUST-TCP-3690"
                          set utm-status enable
                          set profile-type group
                          set profile-group "PG_POS"
                          set logtraffic all
                      next
                      edit 4
                          set name "IPv4-P_3CX-CURBSIDE"
                          set srcintf "POS"
                          set dstintf "virtual-wan-link"
                          set srcaddr "all"
                          set dstaddr "all"
                          set action accept
                          set schedule "always"
                          set service "CUST-TCP-5001"
                          set utm-status enable
                          set profile-type group
                          set profile-group "PG_POS"
                          set logtraffic all
                      next
                      edit 5
                          set name "IPv4-P_CARBON-BLACK"
                          set srcintf "POS"
                          set dstintf "virtual-wan-link"
                          set srcaddr "all"
                          set dstaddr "all"
                          set action accept
                          set schedule "always"
                          set service "CUST-TCP-5050"
                          set utm-status enable
                          set profile-type group
                          set profile-group "PG_POS"
                          set logtraffic all
                      next
                      edit 6
                          set name "IPV-4_BIG-FIX"
                          set srcintf "POS"
                          set dstintf "virtual-wan-link"
                          set srcaddr "all"
                          set dstaddr "all"
                          set action accept
                          set schedule "always"
                          set service "CUST-TCP-UDP-52311"
                          set utm-status enable
                          set profile-type group
                          set profile-group "PG_POS"
                          set logtraffic all
                      next
                      edit 7
                          set name "IPV-4_PING"
                          set srcintf "POS"
                          set dstintf "virtual-wan-link"
                          set srcaddr "all"
                          set dstaddr "all"
                          set action accept
                          set schedule "always"
                          set service "ALL_ICMP" "PING"
                          set utm-status enable
                          set profile-type group
                          set profile-group "PG_POS"
                          set logtraffic all
                      next
                      edit 8
                          set name "IPv4-P_SPLUNK"
                          set srcintf "POS"
                          set dstintf "virtual-wan-link"
                          set srcaddr "all"
                          set dstaddr "all"
                          set action accept
                          set schedule "always"
                          set service "CUST-TCP-9997-9998"
                          set utm-status enable
                          set profile-type group
                          set profile-group "PG_POS"
                      next
                      edit 9
                          set name "IPv4-P_RO-SMART-POS"
                          set srcintf "POS"
                          set dstintf "virtual-wan-link"
                          set srcaddr "all"
                          set dstaddr "all"
                          set action accept
                          set schedule "always"
                          set service "CUST-TCP-3317-3319"
                          set utm-status enable
                          set profile-type group
                          set profile-group "PG_POS"
                          set logtraffic all
                      next
                      edit 10
                          set name "IPv4-P_LDDS"
                          set srcintf "POS"
                          set dstintf "virtual-wan-link"
                          set srcaddr "all"
                          set dstaddr "all"
                          set action accept
                          set schedule "always"
                          set service "CUST-TCP-81-83"
                          set utm-status enable
                          set profile-type group
                          set profile-group "PG_POS"
                          set logtraffic all
                      next
                      edit 11
                          set name "IPv4-P_ESET"
                          set srcintf "POS"
                          set dstintf "virtual-wan-link"
                          set srcaddr "all"
                          set dstaddr "all"
                          set action accept
                          set schedule "always"
                          set service "CUST-TCP-2222"
                          set utm-status enable
                          set profile-type group
                          set profile-group "PG_POS"
                          set logtraffic all
                      next
                      edit 12
                          set name "IPv4-P_TeamViewer"
                          set srcintf "POS"
                          set dstintf "virtual-wan-link"
                          set srcaddr "all"
                          set dstaddr "all"
                          set action accept
                          set schedule "always"
                          set service "CUST-TCP-UDP-5938"
                          set utm-status enable
                          set profile-type group
                          set profile-group "PG_POS"
                          set logtraffic all
                      next
                      edit 13
                          set name "IPv4-P_QUAD9s-DNS"
                          set srcintf "POS"
                          set dstintf "virtual-wan-link"
                          set srcaddr "all"
                          set dstaddr "all"
                          set action accept
                          set schedule "always"
                          set service "DNS"
                          set utm-status enable
                          set profile-type group
                          set profile-group "PG_POS"
                          set logtraffic all
                      next
                      edit 14
                          set name "IPv4-P_NTP"
                          set srcintf "POS"
                          set dstintf "virtual-wan-link"
                          set srcaddr "all"
                          set dstaddr "all"
                          set action accept
                          set schedule "always"
                          set service "NTP"
                          set utm-status enable
                          set profile-type group
                          set profile-group "PG_POS"
                          set logtraffic all
                      next
                      edit 15
                          set name "IPv4-P_HTTP"
                          set srcintf "POS"
                          set dstintf "virtual-wan-link"
                          set srcaddr "all"
                          set dstaddr "all"
                          set action accept
                          set schedule "always"
                          set service "HTTP"
                          set utm-status enable
                          set profile-type group
                          set profile-group "PG_POS"
                          set logtraffic all
                      next
                      edit 16
                          set name "IPv4-P_HTTP-8080"
                          set srcintf "POS"
                          set dstintf "virtual-wan-link"
                          set srcaddr "all"
                          set dstaddr "all"
                          set action accept
                          set schedule "always"
                          set service "CUST-TCP-8080"
                          set utm-status enable
                          set profile-type group
                          set profile-group "PG_POS"
                          set logtraffic all
                      next
                      edit 17
                          set name "IPv4-P_HTTPS"
                          set srcintf "POS"
                          set dstintf "virtual-wan-link"
                          set srcaddr "all"
                          set dstaddr "all"
                          set action accept
                          set schedule "always"
                          set service "HTTPS"
                          set utm-status enable
                          set profile-type group
                          set profile-group "PG_POS"
                          set logtraffic all
                      next
                      edit 18
                          set name "IPv4-P_HTTPS-8443"
                          set srcintf "POS"
                          set dstintf "virtual-wan-link"
                          set srcaddr "all"
                          set dstaddr "all"
                          set action accept
                          set schedule "always"
                          set service "CUST-TCP-8443"
                          set utm-status enable
                          set profile-type group
                          set profile-group "PG_POS"
                          set logtraffic all
                      next
                      edit 21
                          set name "IPv4-P_Portal_Exempt"
                          set srcintf "GuestWLan"
                          set dstintf "virtual-wan-link"
                          set srcaddr "all"
                          set dstaddr "api.openweathermap.org" "api.stripe.com" "d1ldbb6wxu8wdm.cloudfront.net" "dow" "payment-r1.venuewifi.com" "payment-r2.venuewifi.com" "payment-r3.venuewifi.com" "r1-portal.venuewifi.com" "r2-portal.venuewifi.com" "r3-portal.venuewifi.com" "region1.purpleportal.net"
                          set action accept
                          set schedule "always"
                          set service "ALL"
                          set utm-status enable
                          set profile-type group
                          set profile-group "PG_POS"
                          set logtraffic all
                          set global-label "Guest Access"
                          set captive-portal-exempt enable
                      next
                      edit 24
                          set name "IPv4-P_Social_Exempt"
                          set srcintf "GuestWLan"
                          set dstintf "virtual-wan-link"
                          set srcaddr "all"
                          set dstaddr "facebook.com" "www.facebook.com" "m.facebook.com" "scontent-lhr3-1.xx.fbcdn.net" "fbstatic-a.akamaihd.net" "connect.facebook.net" "twitter.com" "www.twitter.com" "api.twitter.com" "abs.twimg.com" "abs-0.twimg.com" "linkedin.com" "www.linkedin.com" "touch.linkedin.com" "static.licdn.com" "instagram.com" "www.instagram.com" "instagramstatic-a.akamaihd.net" "weibo.com" "www.weibo.com" "login.sina.com.cn" "vk.me" "www.vk.me" "vk.com" "www.vk.com"
                          set action accept
                          set schedule "always"
                          set service "ALL"
                          set utm-status enable
                          set profile-type group
                          set profile-group "PG_POS"
                          set logtraffic all
                          set global-label "Guest Access"
                          set captive-portal-exempt enable
                      next
                      edit 22
                          set name "IPv4-P_DNS_Exempt"
                          set srcintf "GuestWLan"
                          set dstintf "virtual-wan-link"
                          set srcaddr "all"
                          set dstaddr "Google Primary DNS" "Google Secondary DNS"
                          set action accept
                          set schedule "always"
                          set service "DNS"
                          set utm-status enable
                          set profile-type group
                          set profile-group "PG_POS"
                          set logtraffic all
                          set global-label "Guest Access"
                          set captive-portal-exempt enable
                      next
                      edit 23
                          set name "IPv4-P_Guest_Disclaimer"
                          set srcintf "GuestWLan"
                          set dstintf "virtual-wan-link"
                          set srcaddr "all"
                          set dstaddr "all"
                          set action accept
                          set status disable
                          set schedule "always"
                          set service "ALL"
                          set utm-status enable
                          set profile-type group
                          set profile-group "PG_POS"
                          set logtraffic all
                          set logtraffic-start enable
                          set disclaimer enable
                          set global-label "Guest Access"
                      next
                      edit 20
                          set name "IPv4-P_Guest-Services-Purple"
                          set srcintf "GuestWLan"
                          set dstintf "virtual-wan-link"
                          set srcaddr "all"
                          set dstaddr "all"
                          set action accept
                          set schedule "always"
                          set service "ALL"
                          set utm-status enable
                          set profile-type group
                          set profile-group "PG_POS"
                          set logtraffic all
                          set logtraffic-start enable
                          set global-label "Guest Access"
                      next
                  end


    - name: run script {{script_adom}} on adom {{adom}}
      fmgr_generic:
        forticloud_access_token: '{{ tokeninfo.json.access_token }}'
        method: exec
        params:
          - url: '/dvmdb/adom/{{adom}}/script/execute'
            data:
              adom: '{{adom}}'
              package: '{{polpkg}}'
              script: '{{script_adom}}'

      register: fmgtask

    - name: wait for run script on adom task
      fmgr_fact:
        forticloud_access_token: '{{ tokeninfo.json.access_token }}'
        facts:
            selector: 'task_task'
            params:
                task: '{{fmgtask.meta.response_data.task}}'
      register: taskinfo
      until: taskinfo.meta.response_data.percent == 100
      retries: 30
      delay: 5
      failed_when: taskinfo.meta.response_data.state == 'error'

    - name: make SDWAN template
      fmgr_generic:
        forticloud_access_token: '{{ tokeninfo.json.access_token }}'
        method: set
        params:
          - url: '/pm/wanprof/adom/{{adom}}'
            data:
              - name: '{{sdwan_tpt}}'
                type: wanprof

    - name: set SDWAN template fields
      fmgr_generic:
        forticloud_access_token: '{{ tokeninfo.json.access_token }}'
        method: set
        params:
          - url: '/pm/wanprof/adom/{{adom}}/{{sdwan_tpt}}'
            data:
              members:
                - seq-num: 1
                  zone: virtual-wan-link
                  interface: [ wan1 ]
                  ingress-spillover-threshold: 0
                  spillover-threshold: 0
                  weight: 1
                  volume-ratio: 1
                  gateway: '0.0.0.0'
                  cost: 0
                  status: 1
                  gateway6: '::'
                  priority: 0
                  source: '0.0.0.0'
                  source6: '::'
                - seq-num: 2
                  zone: virtual-wan-link
                  interface: [ FortiExtender ]
                  ingress-spillover-threshold: 0
                  spillover-threshold: 0
                  weight: 1
                  volume-ratio: 1
                  gateway: '0.0.0.0'
                  cost: 0
                  status: 1
                  gateway6: '::'
                  priority: 0
                  source: '0.0.0.0'
                  source6: '::'

              health-check:
                - name: 'Default_AWS'
                  _dynamic-server: 'Default_AWS'
                - name: 'Default_FortiGuard'
                  _dynamic-server: 'Default_FortiGuard'
                - name: 'Default_Gmail'
                  _dynamic-server: 'Default_Gmail'
                - name: "Default_Google Search"
                  _dynamic-server: "Default_Google Search"
                - name: "Default_Office_365"
                  _dynamic-server: "Default_Office_365"

### IPsec template
